<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <title>SewaLink · Profile</title>
  <meta name="description" content="Manage your profile, portfolio, and settings.">
  
  <!-- PWA / App-like settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2563eb">
  
  <link rel="icon" type="image/png" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232563eb'/%3E%3Cpath d='M30 40 L70 40 L70 60 L30 60 Z' fill='white'/%3E%3Ccircle cx='40' cy='50' r='5' fill='%232563eb'/%3E%3Ccircle cx='60' cy='50' r='5' fill='%232563eb'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* ========== MOBILE-FIRST APP STYLES ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #ffffff;
      color: #0f172a;
      line-height: 1.5;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* ========== BOTTOM NAVIGATION (APP STYLE) ========== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.5rem 1rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      border-top: 1px solid #f1f5f9;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.02);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #64748b;
      font-size: 0.7rem;
      gap: 0.2rem;
      padding: 0.3rem 0.5rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .nav-item i {
      font-size: 1.3rem;
    }
    .nav-item.active {
      color: #2563eb;
    }
    .nav-item span {
      font-size: 0.65rem;
      font-weight: 500;
    }

    /* ========== TOP HEADER ========== */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1rem;
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #f1f5f9;
    }

    .logo {
      font-size: 1.4rem;
      font-weight: 700;
      color: #0f172a;
      text-decoration: none;
    }
    .logo span {
      color: #2563eb;
    }

    .auth-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-outline {
      padding: 0.4rem 1rem;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.8rem;
      color: #1e293b;
      text-decoration: none;
    }

    .btn-primary {
      padding: 0.4rem 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: none;
    }

    /* ========== PROFILE DROPDOWN ========== */
    .profile-container {
      position: relative;
      display: inline-block;
    }
    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      object-fit: cover;
    }
    .dropdown-menu {
      position: absolute;
      top: 45px;
      right: 0;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      width: 240px;
      padding: 0.5rem;
      display: none;
      z-index: 101;
      border: 1px solid #f1f5f9;
    }
    .dropdown-menu.show {
      display: block;
    }
    .user-info {
      padding: 0.8rem;
      border-bottom: 1px solid #f1f5f9;
    }
    .user-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 0.9rem;
    }
    .user-email {
      font-size: 0.75rem;
      color: #64748b;
    }
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.8rem;
      text-decoration: none;
      color: #1e293b;
      font-size: 0.85rem;
      border-radius: 10px;
    }
    .dropdown-item:hover {
      background: #f8fafc;
    }
    .logout-btn {
      width: 100%;
      background: none;
      border: none;
      text-align: left;
      padding: 0.6rem 0.8rem;
      color: #b91c1c;
      border-top: 1px solid #f1f5f9;
      margin-top: 0.25rem;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
    }

    /* ========== MAIN CONTAINER ========== */
    .container {
      padding: 1rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .profile-card {
      background: white;
      border-radius: 24px;
      padding: 1.5rem;
      border: 1px solid #f1f5f9;
      margin-bottom: 1rem;
    }

    /* ========== PROFILE HEADER ========== */
    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .avatar-section {
      position: relative;
      display: inline-block;
    }

    .profile-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .change-avatar-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      background: #2563eb;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid white;
      transition: all 0.2s ease;
    }
    .change-avatar-btn:active {
      background: #1d4ed8;
      transform: scale(1.1);
    }
    #avatarUpload {
      display: none;
    }

    .remove-avatar-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: #ef4444;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid white;
      transition: all 0.2s ease;
      font-size: 0.8rem;
    }
    .remove-avatar-btn:active {
      background: #dc2626;
      transform: scale(1.1);
    }

    .profile-title h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.5rem;
    }

    .profile-title p {
      color: #64748b;
      font-size: 0.95rem;
    }

    .profile-badge {
      display: inline-block;
      background: #eff6ff;
      color: #2563eb;
      padding: 0.3rem 1rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.5rem;
      margin-right: 0.3rem;
    }

    .phone-verified {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: #dcfce7;
      color: #166534;
      padding: 0.2rem 0.8rem;
      border-radius: 50px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* ========== STATS GRID ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-item {
      background: #f8fafc;
      padding: 1.2rem;
      border-radius: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 0.25rem;
    }
    .stat-label {
      color: #64748b;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ========== FRIEND SECTION ========== */
    .friend-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem 1.2rem;
      background: linear-gradient(135deg, #eff6ff, #ffffff);
      border-radius: 20px;
      border: 1px solid #bfdbfe;
    }
    .friend-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }
    .friend-info {
      flex: 1;
    }
    .friend-count {
      font-size: 1.3rem;
      font-weight: 700;
      color: #0f172a;
    }
    .friend-label {
      color: #64748b;
      font-size: 0.8rem;
    }
    .btn-view-friends {
      background: white;
      color: #2563eb;
      border: 1px solid #2563eb;
      padding: 0.5rem 1.2rem;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .btn-view-friends:active {
      background: #2563eb;
      color: white;
    }

    /* ========== EARNINGS SECTION ========== */
    .earnings-section {
      background: linear-gradient(135deg, #fef9c3, #fff);
      padding: 1.2rem;
      border-radius: 20px;
      margin-bottom: 1.5rem;
      border: 1px solid #facc15;
    }
    .earnings-title {
      font-size: 1rem;
      font-weight: 600;
      color: #854d0e;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .earnings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .earnings-item {
      background: white;
      padding: 1rem;
      border-radius: 12px;
    }
    .earnings-label {
      font-size: 0.7rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .earnings-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f172a;
    }

    /* ========== PORTFOLIO SECTION ========== */
    .portfolio-section, .cv-section, .screenshots-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .portfolio-header, .cv-header, .screenshots-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .portfolio-header h2, .cv-header h2, .screenshots-header h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-add-portfolio, .btn-add-cv, .btn-add-screenshot {
      background: #2563eb;
      color: white;
      padding: 0.5rem 1.2rem;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .btn-add-cv {
      background: #8b5cf6;
    }
    .btn-add-screenshot {
      background: #2563eb;
    }

    .portfolio-grid, .screenshots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    .portfolio-item {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #f1f5f9;
      aspect-ratio: 1;
    }
    .portfolio-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .portfolio-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .portfolio-item:active .portfolio-overlay {
      opacity: 1;
    }
    .portfolio-delete {
      background: #ef4444;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
    }

    /* ========== CV GRID ========== */
    .cv-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    .cv-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 1.2rem;
      border: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .cv-icon {
      width: 48px;
      height: 48px;
      background: #e0f2fe;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2563eb;
      font-size: 1.5rem;
    }
    .cv-info {
      flex: 1;
    }
    .cv-name {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 0.2rem;
      font-size: 0.9rem;
    }
    .cv-size {
      color: #64748b;
      font-size: 0.7rem;
    }
    .cv-actions {
      display: flex;
      gap: 0.5rem;
    }
    .cv-download, .cv-delete {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
    }
    .cv-download {
      background: #2563eb;
      color: white;
    }
    .cv-delete {
      background: #ef4444;
      color: white;
    }

    /* ========== EMPTY STATES ========== */
    .portfolio-empty, .cv-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem;
      background: #f8fafc;
      border-radius: 16px;
      color: #64748b;
    }

    /* ========== FORM SECTIONS ========== */
    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f1f5f9;
    }
    .form-section:last-child {
      border-bottom: none;
    }
    .form-section h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.2rem;
    }

    .form-group {
      margin-bottom: 0.5rem;
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      background: #fafcfc;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* ========== SKILLS ========== */
    .skills-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }
    .skill-tag {
      background: #f1f5f9;
      color: #334155;
      padding: 0.4rem 1rem;
      border-radius: 30px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .skill-tag i {
      color: #ef4444;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .skill-tag i:active {
      color: #dc2626;
    }

    .add-skill {
      display: flex;
      gap: 0.5rem;
    }
    .add-skill input {
      flex: 1;
      padding: 0.7rem 1rem;
    }
    .btn-add-skill {
      padding: 0 1.2rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ========== UPLOAD PROGRESS ========== */
    .upload-progress {
      display: none;
      margin-bottom: 1rem;
    }
    .upload-progress.show {
      display: block;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #f1f5f9;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #2563eb;
      width: 0%;
      transition: width 0.3s;
    }

    /* ========== BUTTONS ========== */
    .btn-save {
      width: 100%;
      padding: 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .btn-save:active {
      background: #1d4ed8;
      transform: scale(0.98);
    }
    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ========== MESSAGES ========== */
    .message {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 16px;
      display: none;
    }
    .message.show {
      display: block;
    }
    .message.success {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #86efac;
    }
    .message.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    /* ========== INFO TEXT ========== */
    .info-text {
      color: #64748b;
      font-size: 0.75rem;
      margin-top: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    /* ========== LOADING ========== */
    .loading {
      text-align: center;
      padding: 3rem 1rem;
      color: #64748b;
    }
    .loading i {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    /* ========== BACK BUTTON ========== */
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #2563eb;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    /* ========== BOTTOM PADDING ========== */
    .bottom-padding {
      height: 70px;
    }

    @media (min-width: 768px) {
      .bottom-nav {
        max-width: 400px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 30px 30px 0 0;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
      }
      .profile-header {
        flex-direction: row;
        text-align: left;
      }
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- App Header -->
  <header class="app-header">
    <a href="index.html" class="logo">Sewa<span>Link</span></a>
    <div id="authUI" class="auth-buttons"></div>
  </header>

  <div id="alertContainer"></div>

  <!-- Main Container -->
  <div class="container">
    <a href="javascript:history.back()" class="back-button">
      <i class="fas fa-arrow-left"></i> Back
    </a>
    
    <div id="profileContent" class="profile-card">
      <div class="loading">
        <i class="fas fa-spinner fa-pulse"></i>
        <p>Loading profile...</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="services.html" class="nav-item">
      <i class="fas fa-cogs"></i>
      <span>Services</span>
    </a>
    <a href="jobs.html" class="nav-item">
      <i class="fas fa-briefcase"></i>
      <span>Jobs</span>
    </a>
    <a href="messages.html" class="nav-item">
      <i class="fas fa-comment"></i>
      <span>Chat</span>
    </a>
    <a href="profile.html" class="nav-item active">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </nav>
  
  <div class="bottom-padding"></div>

  <script type="module">
    // ========== FIREBASE IMPORTS ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      getDocs,
      setDoc,
      updateDoc,
      deleteDoc,
      addDoc,
      collection,
      query,
      where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
      apiKey: "AIzaSyCVYHKeB4TXobILCAygM8JIVisKqUGiJ1s",
      authDomain: "sewalink-ead02.firebaseapp.com",
      projectId: "sewalink-ead02",
      storageBucket: "sewalink-ead02.firebasestorage.app",
      messagingSenderId: "682952754486",
      appId: "1:682952754486:web:c0bba16496d78234aa1f97"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== IMGBB API KEY ==========
    const IMGBB_API_KEY = "24c8117ea7fa3be4ac335c4a6259c7d0";
    const IMGBB_UPLOAD_URL = "https://api.imgbb.com/1/upload";

    // ========== DOM ==========
    const authUI = document.getElementById('authUI');
    const profileContent = document.getElementById('profileContent');
    const alertContainer = document.getElementById('alertContainer');

    // ========== STATE ==========
    let currentUser = null;
    let currentSkills = [];
    let portfolioImages = [];
    let cvFiles = [];
    let screenshotFiles = [];

    // ========== CURRENCY FORMATTER ==========
    function formatNPR(amount) {
      if (!amount && amount !== 0) return 'रु 0';
      return `रु ${Number(amount).toLocaleString('ne-NP')}`;
    }

    // ========== ESCAPE HTML ==========
    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' })[c]);
    }

    // ========== FORMAT FILE SIZE ==========
    function formatFileSize(bytes) {
      if (!bytes) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // ========== SHOW ALERT ==========
    function showAlert(message, type = 'success') {
      const div = document.createElement('div');
      div.className = `alert ${type}`;
      div.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span style="flex:1;">${message}</span>
        <button onclick="this.parentElement.remove()" style="background:none; border:none; color:#94a3b8; cursor:pointer; font-size:1.2rem;">×</button>
      `;
      alertContainer.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    // ========== FILE TO BASE64 ==========
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }

    // ========== UPLOAD TO IMGBB ==========
    async function uploadToImgBB(file) {
      const base64 = await fileToBase64(file);
      
      const formData = new FormData();
      formData.append('key', IMGBB_API_KEY);
      formData.append('image', base64);
      formData.append('name', `sewalink-${Date.now()}`);

      const response = await fetch(IMGBB_UPLOAD_URL, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error?.message || 'Upload failed');
      }

      return {
        url: result.data.url,
        display_url: result.data.display_url,
        delete_url: result.data.delete_url,
        delete_hash: result.data.delete_hash,
        thumb: result.data.thumb?.url,
        size: file.size,
        type: file.type,
        name: file.name
      };
    }

    // ========== DELETE FROM IMGBB ==========
    async function deleteFromImgBB(deleteUrl) {
      try {
        if (deleteUrl) {
          await fetch(deleteUrl, { method: 'DELETE' });
        }
        return true;
      } catch (error) {
        console.error('Error deleting from ImgBB:', error);
        return false;
      }
    }

    // ========== AUTH UI ==========
    async function renderAuthUI(user) {
      if (user) {
        currentUser = user;
        
        authUI.innerHTML = `
          <div class="profile-container">
            <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || 'User') + '&background=2563eb&color=fff&size=36'}" class="profile-avatar" id="avatarTrigger">
            <div class="dropdown-menu" id="dropdownMenu">
              <div class="user-info">
                <div class="user-name">${escapeHTML(user.displayName || 'User')}</div>
                <div class="user-email">${escapeHTML(user.email || '')}</div>
              </div>
              <a href="profile.html" class="dropdown-item"><i class="fas fa-user"></i> Profile</a>
              <a href="dashboard.html" class="dropdown-item"><i class="fas fa-chart-pie"></i> Dashboard</a>
              <a href="favorites.html" class="dropdown-item"><i class="fas fa-heart"></i> Favorites</a>
              <a href="messages.html" class="dropdown-item"><i class="fas fa-envelope"></i> Messages</a>
              <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
          </div>
        `;

        const avatar = document.getElementById('avatarTrigger');
        const dropdown = document.getElementById('dropdownMenu');
        
        avatar?.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdown?.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
          if (!avatar?.contains(e.target) && !dropdown?.contains(e.target)) {
            dropdown?.classList.remove('show');
          }
        });

        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
          await signOut(auth);
          window.location.href = 'index.html';
        });
        
      } else {
        authUI.innerHTML = `
          <a href="sign-in.html" class="btn-outline">Sign In</a>
          <a href="sign-up.html" class="btn-primary">Sign Up</a>
        `;
      }
    }

    // ========== LOAD USER STATS ==========
    async function loadUserStats(userId) {
      try {
        const jobsRef = collection(db, 'jobs');
        const q1 = query(jobsRef, where('clientId', '==', userId));
        const q2 = query(jobsRef, where('acceptedBy', '==', userId));
        
        const [postedSnap, acceptedSnap] = await Promise.all([
          getDocs(q1),
          getDocs(q2)
        ]);

        let totalJobs = postedSnap.size;
        let completedJobs = 0;
        let acceptedJobs = acceptedSnap.size;
        let totalEarned = 0;

        postedSnap.forEach(doc => {
          if (doc.data().status === 'completed') completedJobs++;
        });

        acceptedSnap.forEach(doc => {
          if (doc.data().status === 'completed') {
            totalEarned += doc.data().budget || 0;
          }
        });

        return { totalJobs, completedJobs, acceptedJobs, totalEarned };
      } catch (error) {
        console.error('Error loading stats:', error);
        return { totalJobs: 0, completedJobs: 0, acceptedJobs: 0, totalEarned: 0 };
      }
    }

    // ========== LOAD FRIEND COUNT ==========
    async function loadFriendCount(userId) {
      try {
        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        return userSnap.data()?.friends?.length || 0;
      } catch (error) {
        return 0;
      }
    }

    // ========== LOAD PORTFOLIO ==========
    async function loadPortfolio(userId) {
      try {
        const q = query(
          collection(db, 'portfolio'),
          where('userId', '==', userId)
        );
        const snap = await getDocs(q);
        portfolioImages = [];
        snap.forEach(doc => {
          portfolioImages.push({ id: doc.id, ...doc.data() });
        });
        return portfolioImages;
      } catch (error) {
        console.error('Error loading portfolio:', error);
        return [];
      }
    }

    // ========== LOAD CV ==========
    async function loadCV(userId) {
      try {
        const q = query(
          collection(db, 'cv'),
          where('userId', '==', userId)
        );
        const snap = await getDocs(q);
        cvFiles = [];
        snap.forEach(doc => {
          cvFiles.push({ id: doc.id, ...doc.data() });
        });
        return cvFiles;
      } catch (error) {
        console.error('Error loading CV:', error);
        return [];
      }
    }

    // ========== LOAD SCREENSHOTS ==========
    async function loadScreenshots(userId) {
      try {
        const q = query(
          collection(db, 'screenshots'),
          where('userId', '==', userId)
        );
        const snap = await getDocs(q);
        screenshotFiles = [];
        snap.forEach(doc => {
          screenshotFiles.push({ id: doc.id, ...doc.data() });
        });
        return screenshotFiles;
      } catch (error) {
        console.error('Error loading screenshots:', error);
        return [];
      }
    }

    // ========== RENDER SKILLS ==========
    function renderSkills(skills) {
      if (!skills || skills.length === 0) {
        return '<p style="color: #94a3b8; font-size: 0.9rem;">No skills added yet.</p>';
      }
      return skills.map(skill => 
        `<span class="skill-tag">
          ${escapeHTML(skill)}
          <i class="fas fa-times" onclick="window.removeSkill('${escapeHTML(skill)}')"></i>
        </span>`
      ).join('');
    }

    // ========== RENDER PROFILE ==========
    async function renderProfile() {
      if (!currentUser) return;

      const userRef = doc(db, 'users', currentUser.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.exists() ? userSnap.data() : {};
      
      currentSkills = userData.skills || [];
      
      const [stats, friendCount] = await Promise.all([
        loadUserStats(currentUser.uid),
        loadFriendCount(currentUser.uid)
      ]);

      await Promise.all([
        loadPortfolio(currentUser.uid),
        loadCV(currentUser.uid),
        loadScreenshots(currentUser.uid)
      ]);

      const memberSince = currentUser.metadata.creationTime 
        ? new Date(currentUser.metadata.creationTime).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
        : 'Recently';

      profileContent.innerHTML = `
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="avatar-section">
            <img id="profileAvatar" src="${currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName || 'User') + '&background=2563eb&color=fff&size=120'}" class="profile-avatar-large">
            <label for="avatarUpload" class="change-avatar-btn">
              <i class="fas fa-camera"></i>
            </label>
            <input type="file" id="avatarUpload" accept="image/*">
            ${currentUser.photoURL ? `
              <button class="remove-avatar-btn" id="removeAvatarBtn" onclick="window.removeProfilePicture()">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </div>
          <div class="profile-title">
            <h1 id="profileName">${escapeHTML(currentUser.displayName || 'User')}</h1>
            <p>${escapeHTML(currentUser.email || '')}</p>
            <div style="margin-top: 0.8rem;">
              <span class="profile-badge"><i class="fas fa-calendar-alt"></i> ${memberSince}</span>
              <span class="profile-badge"><i class="fas ${userData.role === 'freelancer' ? 'fa-briefcase' : 'fa-user-tie'}"></i> ${escapeHTML(userData.role || 'freelancer')}</span>
              ${userData.phoneNumber ? `<span class="phone-verified"><i class="fas fa-check-circle"></i> Verified</span>` : ''}
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">${stats.totalJobs}</div>
            <div class="stat-label">Posted</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.completedJobs}</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${stats.acceptedJobs}</div>
            <div class="stat-label">Accepted</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${formatNPR(stats.totalEarned)}</div>
            <div class="stat-label">Earned</div>
          </div>
        </div>

        <!-- Friends Section -->
        <div class="friend-section">
          <div class="friend-icon">
            <i class="fas fa-user-friends"></i>
          </div>
          <div class="friend-info">
            <div class="friend-count">${friendCount}</div>
            <div class="friend-label">Friends</div>
          </div>
          <a href="messages.html?tab=friends" class="btn-view-friends">
            <i class="fas fa-user-friends"></i> View
          </a>
        </div>

        <!-- Earnings Section (Freelancer only) -->
        ${userData.role === 'freelancer' || userData.role === 'both' ? `
          <div class="earnings-section">
            <div class="earnings-title">
              <i class="fas fa-coins"></i> Earnings
            </div>
            <div class="earnings-grid">
              <div class="earnings-item">
                <div class="earnings-label">Total Earned</div>
                <div class="earnings-value">${formatNPR(stats.totalEarned)}</div>
              </div>
              <div class="earnings-item">
                <div class="earnings-label">Jobs Done</div>
                <div class="earnings-value">${stats.completedJobs}</div>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Portfolio Section -->
        <div class="portfolio-section">
          <div class="portfolio-header">
            <h2><i class="fas fa-images"></i> Portfolio</h2>
            <button class="btn-add-portfolio" id="addPortfolioBtn">
              <i class="fas fa-plus"></i> Add
            </button>
          </div>
          <div id="portfolioUploadProgress" class="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="portfolioProgressFill" style="width: 0%;"></div>
            </div>
          </div>
          <div id="portfolioContainer" class="portfolio-grid"></div>
        </div>

        <!-- CV Section -->
        <div class="cv-section">
          <div class="cv-header">
            <h2><i class="fas fa-file-alt"></i> CV / Resume</h2>
            <button class="btn-add-cv" id="addCVBtn">
              <i class="fas fa-upload"></i> Upload
            </button>
          </div>
          <div id="cvUploadProgress" class="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="cvProgressFill" style="width: 0%;"></div>
            </div>
          </div>
          <div id="cvContainer" class="cv-grid"></div>
        </div>

        <!-- Screenshots Section -->
        <div class="screenshots-section">
          <div class="screenshots-header">
            <h2><i class="fas fa-camera"></i> Work Samples</h2>
            <button class="btn-add-screenshot" id="addScreenshotBtn">
              <i class="fas fa-plus"></i> Add
            </button>
          </div>
          <div id="screenshotUploadProgress" class="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="screenshotProgressFill" style="width: 0%;"></div>
            </div>
          </div>
          <div id="screenshotsContainer" class="screenshots-grid portfolio-grid"></div>
        </div>

        <!-- Edit Profile Form -->
        <form id="profileForm">
          <div class="form-section">
            <h2><i class="fas fa-user-circle"></i> Basic Info</h2>
            <div class="form-grid">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="displayName" value="${escapeHTML(currentUser.displayName || '')}" required>
              </div>
              <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" id="phoneNumber" value="${escapeHTML(userData.phoneNumber || '')}" placeholder="+977" required>
                <div class="info-text">
                  <i class="fas fa-info-circle"></i> Required for WhatsApp
                </div>
              </div>
              <div class="form-group">
                <label>Location</label>
                <input type="text" id="location" value="${escapeHTML(userData.location || '')}" placeholder="City, Country">
              </div>
              <div class="form-group">
                <label>Bio</label>
                <textarea id="bio" placeholder="Tell clients about yourself...">${escapeHTML(userData.bio || '')}</textarea>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2><i class="fas fa-briefcase"></i> Professional</h2>
            <div class="form-grid">
              <div class="form-group">
                <label>Role</label>
                <select id="role">
                  <option value="freelancer" ${userData.role === 'freelancer' ? 'selected' : ''}>Freelancer</option>
                  <option value="client" ${userData.role === 'client' ? 'selected' : ''}>Client</option>
                  <option value="both" ${userData.role === 'both' ? 'selected' : ''}>Both</option>
                </select>
              </div>
              <div class="form-group">
                <label>Hourly Rate (रु)</label>
                <input type="number" id="hourlyRate" value="${userData.hourlyRate || ''}" placeholder="500">
              </div>
              <div class="form-group">
                <label>Skills</label>
                <div id="skillsContainer" class="skills-container">
                  ${renderSkills(currentSkills)}
                </div>
                <div class="add-skill">
                  <input type="text" id="newSkill" placeholder="Add a skill...">
                  <button type="button" class="btn-add-skill" id="addSkillBtn">Add</button>
                </div>
              </div>
              <div class="form-group">
                <label>Website</label>
                <input type="url" id="website" value="${escapeHTML(userData.website || '')}" placeholder="https://...">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2><i class="fas fa-share-alt"></i> Social Links</h2>
            <div class="form-grid">
              <div class="form-group">
                <label><i class="fab fa-linkedin"></i> LinkedIn</label>
                <input type="url" id="linkedin" value="${escapeHTML(userData.linkedin || '')}" placeholder="https://linkedin.com/in/...">
              </div>
              <div class="form-group">
                <label><i class="fab fa-github"></i> GitHub</label>
                <input type="url" id="github" value="${escapeHTML(userData.github || '')}" placeholder="https://github.com/...">
              </div>
            </div>
          </div>

          <button type="submit" class="btn-save" id="saveProfileBtn">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </form>

        <div id="message" class="message"></div>
      `;

      renderPortfolio();
      renderCV();
      renderScreenshots();
      initializeEventListeners();
    }

    // ========== RENDER PORTFOLIO ==========
    function renderPortfolio() {
      const container = document.getElementById('portfolioContainer');
      if (!container) return;

      if (portfolioImages.length === 0) {
        container.innerHTML = `
          <div class="portfolio-empty">
            <i class="fas fa-images" style="font-size: 2rem; color: #94a3b8; margin-bottom: 1rem;"></i>
            <p>No portfolio items yet.</p>
          </div>
        `;
        return;
      }

      let html = '';
      portfolioImages.forEach(img => {
        html += `
          <div class="portfolio-item">
            <img src="${img.thumb || img.display_url || img.url}" loading="lazy">
            <div class="portfolio-overlay">
              <button class="portfolio-delete" onclick="window.deletePortfolioItem('${img.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ========== RENDER CV ==========
    function renderCV() {
      const container = document.getElementById('cvContainer');
      if (!container) return;

      if (cvFiles.length === 0) {
        container.innerHTML = `
          <div class="cv-empty">
            <i class="fas fa-file-upload" style="font-size: 2rem; color: #94a3b8; margin-bottom: 1rem;"></i>
            <p>No CV uploaded yet.</p>
          </div>
        `;
        return;
      }

      let html = '';
      cvFiles.forEach(cv => {
        html += `
          <div class="cv-card">
            <div class="cv-icon">
              <i class="fas ${cv.type?.includes('pdf') ? 'fa-file-pdf' : 'fa-file-alt'}"></i>
            </div>
            <div class="cv-info">
              <div class="cv-name">${escapeHTML(cv.name || 'CV')}</div>
              <div class="cv-size">${cv.size ? formatFileSize(cv.size) : '1.2 MB'}</div>
            </div>
            <div class="cv-actions">
              ${cv.display_url ? `
                <a href="${cv.display_url}" target="_blank" class="cv-download">
                  <i class="fas fa-download"></i>
                </a>
              ` : ''}
              <button class="cv-delete" onclick="window.deleteCVItem('${cv.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ========== RENDER SCREENSHOTS ==========
    function renderScreenshots() {
      const container = document.getElementById('screenshotsContainer');
      if (!container) return;

      if (screenshotFiles.length === 0) {
        container.innerHTML = `
          <div class="portfolio-empty">
            <i class="fas fa-camera" style="font-size: 2rem; color: #94a3b8; margin-bottom: 1rem;"></i>
            <p>No screenshots yet.</p>
          </div>
        `;
        return;
      }

      let html = '';
      screenshotFiles.forEach(img => {
        html += `
          <div class="portfolio-item">
            <img src="${img.thumb || img.display_url || img.url}" loading="lazy">
            <div class="portfolio-overlay">
              <button class="portfolio-delete" onclick="window.deleteScreenshotItem('${img.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ========== INITIALIZE EVENT LISTENERS ==========
    function initializeEventListeners() {
      // Avatar Upload
      const avatarUpload = document.getElementById('avatarUpload');
      if (avatarUpload) {
        avatarUpload.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            showAlert('Uploading image...', 'success');
            const imageData = await uploadToImgBB(file);
            
            await updateProfile(currentUser, {
              photoURL: imageData.display_url
            });

            const userRef = doc(db, 'users', currentUser.uid);
            await setDoc(userRef, {
              photoURL: imageData.display_url,
              avatarImgBB: imageData,
              updatedAt: serverTimestamp()
            }, { merge: true });

            document.getElementById('profileAvatar').src = imageData.display_url;
            showAlert('✅ Profile picture updated!', 'success');
            
          } catch (error) {
            console.error('Error uploading avatar:', error);
            showAlert('Failed to upload image', 'error');
          }
        });
      }

      // Add Portfolio
      const addPortfolioBtn = document.getElementById('addPortfolioBtn');
      if (addPortfolioBtn) {
        addPortfolioBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.multiple = true;
          
          input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            const progressDiv = document.getElementById('portfolioUploadProgress');
            const progressFill = document.getElementById('portfolioProgressFill');
            
            progressDiv.classList.add('show');
            
            for (let i = 0; i < files.length; i++) {
              try {
                progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
                
                const imageData = await uploadToImgBB(files[i]);
                
                const docRef = await addDoc(collection(db, 'portfolio'), {
                  userId: currentUser.uid,
                  ...imageData,
                  createdAt: serverTimestamp()
                });

                portfolioImages.push({ id: docRef.id, ...imageData });

              } catch (error) {
                console.error('Error uploading portfolio:', error);
              }
            }

            progressDiv.classList.remove('show');
            progressFill.style.width = '0%';
            renderPortfolio();
            showAlert(`✅ Uploaded ${files.length} images`, 'success');
          };
          
          input.click();
        });
      }

      // Add CV
      const addCVBtn = document.getElementById('addCVBtn');
      if (addCVBtn) {
        addCVBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png';
          
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const progressDiv = document.getElementById('cvUploadProgress');
            const progressFill = document.getElementById('cvProgressFill');
            
            progressDiv.classList.add('show');
            progressFill.style.width = '50%';
            
            try {
              let cvData;
              
              if (file.type.startsWith('image/')) {
                cvData = await uploadToImgBB(file);
              } else {
                cvData = {
                  name: file.name,
                  size: file.size,
                  type: file.type,
                  placeholder: 'https://ui-avatars.com/api/?name=CV&background=8b5cf6&color=fff'
                };
              }

              const docRef = await addDoc(collection(db, 'cv'), {
                userId: currentUser.uid,
                ...cvData,
                isImage: file.type.startsWith('image/'),
                createdAt: serverTimestamp()
              });

              cvFiles.unshift({ id: docRef.id, ...cvData });
              
              progressFill.style.width = '100%';
              setTimeout(() => {
                progressDiv.classList.remove('show');
                progressFill.style.width = '0%';
              }, 500);
              
              renderCV();
              showAlert('✅ CV uploaded!', 'success');
              
            } catch (error) {
              console.error('Error uploading CV:', error);
              showAlert('Failed to upload CV', 'error');
              progressDiv.classList.remove('show');
            }
          };
          
          input.click();
        });
      }

      // Add Screenshot
      const addScreenshotBtn = document.getElementById('addScreenshotBtn');
      if (addScreenshotBtn) {
        addScreenshotBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.multiple = true;
          
          input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            const progressDiv = document.getElementById('screenshotUploadProgress');
            const progressFill = document.getElementById('screenshotProgressFill');
            
            progressDiv.classList.add('show');
            
            for (let i = 0; i < files.length; i++) {
              try {
                progressFill.style.width = `${((i + 1) / files.length) * 100}%`;
                
                const imageData = await uploadToImgBB(files[i]);
                
                const docRef = await addDoc(collection(db, 'screenshots'), {
                  userId: currentUser.uid,
                  ...imageData,
                  createdAt: serverTimestamp()
                });

                screenshotFiles.push({ id: docRef.id, ...imageData });

              } catch (error) {
                console.error('Error uploading screenshot:', error);
              }
            }

            progressDiv.classList.remove('show');
            progressFill.style.width = '0%';
            renderScreenshots();
            showAlert(`✅ Uploaded ${files.length} screenshots`, 'success');
          };
          
          input.click();
        });
      }

      // Add Skill
      const addSkillBtn = document.getElementById('addSkillBtn');
      const newSkillInput = document.getElementById('newSkill');
      
      if (addSkillBtn && newSkillInput) {
        addSkillBtn.addEventListener('click', () => {
          const skill = newSkillInput.value.trim();
          if (skill && !currentSkills.includes(skill)) {
            currentSkills.push(skill);
            document.getElementById('skillsContainer').innerHTML = renderSkills(currentSkills);
            newSkillInput.value = '';
          }
        });
        
        newSkillInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addSkillBtn.click();
          }
        });
      }

      // Profile Form Submit
      const profileForm = document.getElementById('profileForm');
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const saveBtn = document.getElementById('saveProfileBtn');
          const messageDiv = document.getElementById('message');

          const displayName = document.getElementById('displayName').value.trim();
          const phoneNumber = document.getElementById('phoneNumber').value.trim();

          if (!displayName || !phoneNumber) {
            messageDiv.className = 'message error show';
            messageDiv.textContent = 'Name and phone number are required.';
            return;
          }

          try {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Saving...';

            await updateProfile(currentUser, { displayName });

            const userRef = doc(db, 'users', currentUser.uid);
            await setDoc(userRef, {
              uid: currentUser.uid,
              displayName,
              email: currentUser.email,
              phoneNumber,
              location: document.getElementById('location')?.value.trim() || '',
              bio: document.getElementById('bio')?.value.trim() || '',
              role: document.getElementById('role')?.value || 'freelancer',
              hourlyRate: document.getElementById('hourlyRate')?.value ? Number(document.getElementById('hourlyRate').value) : null,
              skills: currentSkills,
              website: document.getElementById('website')?.value.trim() || '',
              linkedin: document.getElementById('linkedin')?.value.trim() || '',
              github: document.getElementById('github')?.value.trim() || '',
              updatedAt: serverTimestamp()
            }, { merge: true });

            document.getElementById('profileName').textContent = displayName;
            
            messageDiv.className = 'message success show';
            messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> Profile updated successfully!';
            
            setTimeout(() => messageDiv.classList.remove('show'), 3000);

          } catch (error) {
            console.error('Error updating profile:', error);
            messageDiv.className = 'message error show';
            messageDiv.textContent = 'Failed to update profile.';
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
          }
        });
      }
    }

    // ========== GLOBAL FUNCTIONS ==========
    window.removeSkill = function(skill) {
      currentSkills = currentSkills.filter(s => s !== skill);
      const container = document.getElementById('skillsContainer');
      if (container) container.innerHTML = renderSkills(currentSkills);
    };

    window.removeProfilePicture = async function() {
      if (!currentUser || !confirm('Remove profile picture?')) return;
      
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();
        
        if (userData?.avatarImgBB?.delete_url) {
          await deleteFromImgBB(userData.avatarImgBB.delete_url);
        }

        await updateProfile(currentUser, { photoURL: null });
        await updateDoc(userRef, { photoURL: null, avatarImgBB: null });

        document.getElementById('profileAvatar').src = 
          `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'User')}&background=2563eb&color=fff&size=120`;
        
        document.getElementById('removeAvatarBtn')?.remove();
        showAlert('Profile picture removed', 'success');
        
      } catch (error) {
        console.error('Error removing avatar:', error);
        showAlert('Failed to remove picture', 'error');
      }
    };

    window.deletePortfolioItem = async function(imageId) {
      const image = portfolioImages.find(img => img.id === imageId);
      if (!image || !confirm('Delete this image?')) return;
      
      try {
        if (image.delete_url) await deleteFromImgBB(image.delete_url);
        await deleteDoc(doc(db, 'portfolio', imageId));
        portfolioImages = portfolioImages.filter(img => img.id !== imageId);
        renderPortfolio();
        showAlert('Image deleted', 'success');
      } catch (error) {
        console.error('Error deleting portfolio:', error);
        showAlert('Failed to delete', 'error');
      }
    };

    window.deleteCVItem = async function(cvId) {
      const cv = cvFiles.find(c => c.id === cvId);
      if (!cv || !confirm('Delete this CV?')) return;
      
      try {
        if (cv.delete_url) await deleteFromImgBB(cv.delete_url);
        await deleteDoc(doc(db, 'cv', cvId));
        cvFiles = cvFiles.filter(c => c.id !== cvId);
        renderCV();
        showAlert('CV deleted', 'success');
      } catch (error) {
        console.error('Error deleting CV:', error);
        showAlert('Failed to delete', 'error');
      }
    };

    window.deleteScreenshotItem = async function(screenshotId) {
      const screenshot = screenshotFiles.find(s => s.id === screenshotId);
      if (!screenshot || !confirm('Delete this screenshot?')) return;
      
      try {
        if (screenshot.delete_url) await deleteFromImgBB(screenshot.delete_url);
        await deleteDoc(doc(db, 'screenshots', screenshotId));
        screenshotFiles = screenshotFiles.filter(s => s.id !== screenshotId);
        renderScreenshots();
        showAlert('Screenshot deleted', 'success');
      } catch (error) {
        console.error('Error deleting screenshot:', error);
        showAlert('Failed to delete', 'error');
      }
    };

    // ========== AUTH STATE LISTENER ==========
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'sign-in.html';
        return;
      }
      currentUser = user;
      await renderAuthUI(user);
      await renderProfile();
    });

    // ========== EXPOSE GLOBALS ==========
    window.removeSkill = removeSkill;
    window.removeProfilePicture = removeProfilePicture;
    window.deletePortfolioItem = deletePortfolioItem;
    window.deleteCVItem = deleteCVItem;
    window.deleteScreenshotItem = deleteScreenshotItem;
  </script>
</body>
</html>